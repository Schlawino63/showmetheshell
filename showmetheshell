#!/usr/bin/env perl

use strict;
use warnings;

use FindBin;

BEGIN {
    use lib "$FindBin::Bin/contrib/protocol-websocket/lib";
    use lib "$FindBin::Bin/contrib/event_reactor/lib";
    use lib "$FindBin::Bin/contrib/reanimator/lib";
}

use lib 'lib';

#use constant DEBUG => !!$ENV{SHOWMETHESHELL_DEBUG};

use JSON;
use ReAnimator;
use Terminal;

$SIG{INT} = $SIG{TERM} = sub { exit 0 };

my $server = ReAnimator->new;

ReAnimator->new(
    on_accept => sub {
        my ($self, $client) = @_;

        my $terminal = Terminal->new(
            cmd            => '/bin/sh',
            on_row_changed => sub {
                my ($self, $row, $text) = @_;

                $client->send_message(
                    JSON->new->encode(
                        {type => 'row', row => $row, text => $text}
                    )
                );
            },
            on_finished => sub {
                $self->drop($client);
            }
        );

        $self->event_reactor->add_atom($terminal);

        $terminal->start;

        $client->on_message(
            sub {
                my ($client, $message) = @_;

                my $json = JSON->new;

                eval { $message = $json->decode($message); };
                return if !$message || $@;

                my $type = $message->{type};
                if ($type eq 'key') {
                    my $buffer;

                    my $code = $message->{code};

                    $terminal->key($code);
                }
                elsif ($type eq 'action') {
                    $terminal->move($message->{action});
                }
                else {
                    warn "Unknown type '$type'";
                }

            }
        );
    }
)->listen->start;
